Private Sub CommandButton1_Click()

    ' Define worksheet reference
    Dim ws As Worksheet
    Dim lastRow As Long
    Dim nextAvailableRow As Long
    Dim tradeDate As String
    Dim timeElapsedFormula As String
    Dim adjustmentFormula As String
    Dim adjustmentCellAddress As String

    Set ws = ThisWorkbook.Sheets("Sheet1") ' Change "Sheet1" to your actual sheet name

    ' Get the trade date from the text box
    tradeDate = Me.TextBox3.Value    ' Trade Date from TextBox3

    ' Find the last row in column B and add new data 3 rows below
    lastRow = ws.Cells(ws.Rows.Count, 2).End(xlUp).Row

    ' Insert data into the worksheet
    ws.Cells(lastRow + 3, 2).Value = "TRADE ID"          ' Title in column B
    ws.Cells(lastRow + 3, 3).Value = Me.TextBox1.Value    ' Value from TextBox1 (Trade ID) in column C

    ' Insert the Valuation Date as a reference to H1
    ws.Cells(lastRow + 4, 2).Value = "Valuation Date"     ' Title in column B
    ws.Cells(lastRow + 4, 3).Formula = "=H1"              ' Reference to cell H1 for Valuation Date

    ws.Cells(lastRow + 5, 2).Value = "Trade Date"         ' Title in column B
    ws.Cells(lastRow + 5, 3).Value = Me.TextBox3.Value    ' Value from TextBox3 (Trade Date) in column C

    ws.Cells(lastRow + 6, 2).Value = "Day 1 P&L"          ' Title in column B
    ws.Cells(lastRow + 6, 3).Value = Me.TextBox4.Value    ' Value from TextBox4 (Day 1 P&L) in column C

    ' Insert the Time Elapsed formula
    ' =((Valuation Date - Trade Date)/365)*12
    timeElapsedFormula = "=((C" & (lastRow + 4) & " - C" & (lastRow + 5) & ")/365)*12"
    ws.Cells(lastRow + 7, 2).Value = "Time Elapsed"       ' Title in column B
    ws.Cells(lastRow + 7, 3).Formula = timeElapsedFormula ' Insert Time Elapsed formula in column C

    ' Insert the Adjustment formula
    ' =MAX(0, Day 1 P&L * (12 - Time Elapsed) / 12)
    adjustmentFormula = "=MAX(0, C" & (lastRow + 6) & " * (12 - C" & (lastRow + 7) & ") / 12)"
    ws.Cells(lastRow + 8, 2).Value = "Adjustment"         ' Title in column B
    ws.Cells(lastRow + 8, 3).Formula = adjustmentFormula  ' Insert Adjustment formula in column C

    ' Store the cell address of the adjustment formula
    adjustmentCellAddress = ws.Cells(lastRow + 8, 3).Address

    ' Clear the text boxes after submission
    Me.TextBox1.Value = ""
    Me.TextBox3.Value = ""
    Me.TextBox4.Value = ""

    ' ====================
    ' Insert TRADE ID into column F and Adjustment cell reference into column I
    ' ====================
    
    ' Find the next available row in column F starting after row 13
    nextAvailableRow = ws.Cells(ws.Rows.Count, 6).End(xlUp).Row + 1
    If nextAvailableRow < 14 Then nextAvailableRow = 14 ' Ensure we start from row 14

    ' Insert the TRADE ID from TextBox1 into column F in the next available row
    ws.Cells(nextAvailableRow, 6).Value = Me.TextBox1.Value

    ' Insert the address of the Adjustment cell into column I in the same row
    ws.Cells(nextAvailableRow, 9).Value = adjustmentCellAddress

    ' ====================
    ' Insert formulas into columns H, J, L, M based on the identified row
    ' ====================
    
    ' Set Column H to =-G(row)
    ws.Cells(nextAvailableRow, 8).Formula = "=-G" & nextAvailableRow

    ' Set Column J to =H(row)+I(row)
    ws.Cells(nextAvailableRow, 10).Formula = "=H" & nextAvailableRow & "+I" & nextAvailableRow

    ' Set Column L to =J(row)-((K(row)*2/3))
    ws.Cells(nextAvailableRow, 12).Formula = "=J" & nextAvailableRow & "-((K" & nextAvailableRow & "*2/3))"

    ' Set Column M to =J(row)+((K(row)*1/3))
    ws.Cells(nextAvailableRow, 13).Formula = "=J" & nextAvailableRow & "+((K" & nextAvailableRow & "*1/3))"

End Sub
